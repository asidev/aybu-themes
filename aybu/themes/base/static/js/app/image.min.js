Ext.ns("Aybu.Image");var minSize=75;var maxSize=350;var incSize=50;Aybu.Image.DataWriter=Ext.extend(Ext.data.DataWriter,{render:function(b,c,a){Ext.apply(b,c);Ext.apply(b,a)},create:function(a){return this.createRecord(a)},update:function(a){return this.updateRecord(a)},destroy:function(a){return this.destroyRecord(a)},createRecord:function(a){return a.data},updateRecord:function(a){return{id:a.get("id"),name:a.get("name")}},destroyRecord:function(a){return{id:a.get("id")}}});Aybu.Image.Store=new Ext.extend(Aybu.Base.Store,{constructor:function(a){a=a||{};Ext.applyIf(a,{idProperty:"id",root:"data",successProperty:"success",totalProperty:"datalen",autoSave:true,fields:[{name:"id",type:"int"},"name","url","thumb_url","used_by",{name:"thumb_width",type:"int"},{name:"thumb_height",type:"int"},{name:"width",type:"int"},{name:"height",type:"int"},"content_type","path",{name:"size",type:"int"}],sortInfo:{field:"name",direction:"ASC"},writer:new Aybu.Image.DataWriter(),proxy:new Ext.data.HttpProxy({api:{read:{url:urls.list,method:"GET"},create:urls.list,update:{url:urls.update,method:"GET"},destroy:{url:urls.remove,method:"GET"}},listeners:{exception:this.onProxyException,scope:this}})});Aybu.Image.Store.superclass.constructor.call(this,a)},onProxyException:function(d,e,f,c,b,a){Ext.Msg.alert("Errore connessione al server.","Non e' stato possibile completare l'operazione: "+f+".")}});Ext.reg("AybuImageStore",Aybu.Image.Store);Aybu.Image.DataView=new Ext.extend(Aybu.Base.DataView,{constructor:function(a){a=a||{};a.store=a.store||{};Ext.applyIf(a.store,{xtype:"AybuImageStore",listeners:{load:this.onStoreLoad,scope:this}});Ext.applyIf(a,{emptyText:'<div class="plupload_emptytext"><span>Nessuna immagine disponibile.</span></div>',tpl:new Ext.XTemplate('<tpl for=".">','<div class="thumb-wrap" id="{id}">','<div class="thumb"><img src="{thumb_url}" alt="{name}" title="{name} - [{size_string}]"></div>','<span class="name x-editable"><b>{short_name}</b></span></div>',"</tpl>",'<div class="x-clear"></div>'),prepareData:function(b){b.short_name=Ext.util.Format.ellipsis(b.name,15);b.size_string=Ext.util.Format.fileSize(b.size);return b},plugins:[new Ext.DataView.DragSelector(),new Ext.DataView.LabelEditor({dataIndex:"name"})]});Aybu.Image.DataView.superclass.constructor.call(this,a)},initComponent:function(){Aybu.Image.DataView.superclass.initComponent.apply(this,arguments);this.addEvents("storeload");this.addListener("dblclick",this.onDoubleClick,this)},onStoreLoad:function(){this.fireEvent("storeload")},onDoubleClick:function(b,c,e,d){var g=b.getRecord(e).json;var a=new Ext.Panel({width:g.width,height:g.height,html:'<img src="'+g.url+'"/>'});var f=new Ext.Window({title:g.name,width:g.width+20,height:g.height+100,x:25,y:25,closeAction:"hide",plain:true,layout:"fit",items:[a]});f.show()}});Ext.reg("AybuImageDataView",Aybu.Image.DataView);Aybu.Image.UploadButton=new Ext.extend(Ext.ux.PluploadButton,{constructor:function(a){a=a||{};a.upload_config=a.upload_config||{};Ext.applyIf(a.upload_config,{url:urls.add,runtimes:"gears,flash,silverlight,html5,browserplus,html4",multipart:true,multipart_params:{param1:1,param2:2},max_file_size:"10mb",flash_swf_url:"/static/js/lib/plupload/plupload.flash.swf",silverlight_xap_url:"/static/js/lib/plupload/plupload.silverlight.xap",filters:[{title:"Image files",extensions:"jpg,JPG,gif,GIF,png,PNG"}],runtime_visible:false,addButtonCls:"silk-add",uploadButtonCls:"silk-arrow-up",cancelButtonCls:"silk-stop",deleteButtonCls:"silk-cross",addButtonText:"Aggiungi",uploadButtonText:"Upload",cancelButtonText:"Termina upload",deleteButtonText:"Rimuovi dalla coda",deleteSelectedText:"<b>selezionati</b>",deleteUploadedText:"caricati",deleteAllText:"tutti",statusQueuedText:"In coda",statusUploadingText:"Uploading ({0}%)",statusFailedText:'<span style="color: red">Fallito</span>',statusDoneText:'<span style="color: green">Ok</span>',statusInvalidSizeText:"Le dimensioni del file sono oltre il massimo consentito",statusInvalidExtensionText:"Tipo di file non valido",emptyText:'<div class="plupload_emptytext"><span>Coda vuota</span></div>',emptyDropText:'<div class="plupload_emptytext"><span>Trascina i file qui</span></div>',progressText:"{0}/{1} ({3} falliti) ({5}/s)",listeners:{uploadcomplete:this.onUploadComplete,scope:this}});Ext.applyIf(a,{text:"Aggiungi",itemId:"addButton",iconCls:"silk-add",window_width:380,window_height:300,clearOnClose:true,window_title:"Carica Immagini"});Aybu.Image.UploadButton.superclass.constructor.call(this,a)},initComponent:function(){Aybu.Image.UploadButton.superclass.initComponent.apply(this,arguments);this.addEvents("uploadsuccessful")},onUploadComplete:function(a,c,b){if(c.length&&!b.length){this.fireEvent("uploadsuccessful");this.window.hide()}}});Ext.reg("AybuImageUploadButton",Aybu.Image.UploadButton);Aybu.Image.Toolbar=Ext.extend(Aybu.Base.Toolbar,{constructor:function(a){a=a||{};a.buttonsCfg=a.buttonsCfg||{};Ext.applyIf(a.buttonsCfg,{select:true,edit:true,delete_:true});a.buttonsCfg.add=a.buttonsCfg.add||{};a.buttonsCfg.add.cfg=a.buttonsCfg.add.cfg||{};Ext.applyIf(a.buttonsCfg.add.cfg,{xtype:"AybuImageUploadButton",listeners:{uploadsuccessful:this.onUploadSuccessful,scope:this}});Ext.applyIf(a,{items:["->",{xtype:"textfield",emptyText:"Cerca per nome",id:"search",width:100,enableKeyEvents:true,listeners:{specialkey:function(c,b){this.fireEvent("search",c.getValue())},keyup:function(c,b){this.fireEvent("search",c.getValue())},scope:this}},"  ",{text:"",itemId:"clearsearch",iconCls:"silk-clear",handler:this.onClearSearch,scope:this}," "," ","-"," "," ",{text:"",iconCls:"silk-zoomout",itemId:"sizeDec",listeners:{click:this.onZoomOut,scope:this}},new Ext.slider.SingleSlider({itemId:"resizer",width:100,value:100,animate:false,value:minSize,increment:incSize,minValue:minSize,maxValue:maxSize,listeners:{change:this.onResizeComplete,scope:this}}),{text:"",iconCls:"silk-zoomin",itemId:"sizeInc",listeners:{click:this.onZoomIn,scope:this}}]});Aybu.Image.Toolbar.superclass.constructor.call(this,a)},initComponent:function(){Aybu.Image.Toolbar.superclass.initComponent.apply(this,arguments);this.addEvents("uploadsuccessful","zoom","search")},onUploadSuccessful:function(){this.fireEvent("uploadsuccessful")},onClearSearch:function(){var a=this.getComponent("search");a.setValue("");this.fireEvent("search",a.getValue())},onResizeComplete:function(){var b=this.getComponent("resizer").getValue();var a=this.getComponent("sizeDec");var c=this.getComponent("sizeInc");if(b<=minSize){a.disable()}else{a.enable()}if(b>=maxSize){c.disable()}else{c.enable()}this.fireEvent("zoom",b)},onZoomOut:function(){slider=this.getComponent("resizer");value=slider.getValue();if(value>minSize){slider.setValue(value-incSize)}},onZoomIn:function(){slider=this.getComponent("resizer");value=slider.getValue();if(value<maxSize){slider.setValue(value+incSize)}}});Ext.reg("AybuImageToolbar",Aybu.Image.Toolbar);Aybu.Image.Panel=Ext.extend(Aybu.Base.Panel,{constructor:function(a){a=a||{};Ext.applyIf(a,{id:"images-view",autoScroll:true,tbar:{xtype:"AybuImageToolbar",buttonsCfg:{select:true,add:{cfg:{xtype:"AybuImageUploadButton",listeners:{uploadsuccessful:this.onUploadSuccessful,scope:this}}},edit:true,delete_:true}},items:{xtype:"AybuImageDataView"}});Aybu.Image.Panel.superclass.constructor.call(this,a)},initComponent:function(){Aybu.Image.Panel.superclass.initComponent.apply(this,arguments);this.getTopToolbar().addListener("uploadsuccessful",this.onUploadSuccessful,this);this.getTopToolbar().addListener("zoom",this.onZoom,this);this.getTopToolbar().addListener("search",this.onSearch,this);this.getComponent(0).addListener("storeload",this.onStoreLoad,this)},onUploadSuccessful:function(){this.getComponent(0).store.reload()},onEditSelected:function(){var a=this.getComponent("dataview");this.editWindow.show();this.editWindow.setRecord(a.getSelectedRecords()[0])},onZoom:function(a){if(a){jQuery("#images-view .thumb img").css("width",a);jQuery("#images-view .thumb img").css("height",a*0.8)}},onSearch:function(b){var a=this.getComponent("dataview");a.getStore().filter("name",b,true,false);this.getTopToolbar().getComponent("resizer").setValue(100)},onStoreLoad:function(){this.getTopToolbar().getComponent("search").setValue("")}});Ext.reg("AybuImagePanel",Aybu.Image.Panel);Aybu.Image.Window=Ext.extend(Aybu.Base.Window,{constructor:function(a){a=a||{};Ext.applyIf(a,{title:"Gestione Immagini",width:640,height:320,items:{xtype:"AybuImagePanel"}});Aybu.Image.Window.superclass.constructor.call(this,a)},});Ext.reg("AybuImageWindow",Aybu.Image.Window);