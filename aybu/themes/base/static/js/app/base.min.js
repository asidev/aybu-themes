Ext.ns("Aybu.Base");Aybu.Base.Store=Ext.extend(Ext.data.JsonStore,{constructor:function(a){a=a||{};a.writer=a.writer||{};Ext.applyIf(a.writer,{encode:true,writeAllFields:true});Ext.applyIf(a,{autoLoad:true,autoSave:false,proxy:new Ext.data.HttpProxy({url:a.httpProxyUrl,restful:true}),root:"dataset"});Aybu.Base.Store.superclass.constructor.call(this,a)},initComponent:function(){Aybu.Base.Store.superclass.initComponent.apply(this,arguments);this.addEvents("datachanged")}});Ext.reg("AybuBaseStore",Aybu.Base.Store);Aybu.Base.DataView=Ext.extend(Ext.DataView,{constructor:function(a){a=a||{};Ext.applyIf(a,{itemId:"dataview",autoHeight:true,multiSelect:true,overClass:"x-view-over",itemSelector:"div.thumb-wrap",store:{xtype:"AybuBaseStore"},tpl:new Ext.XTemplate('<tpl for=".">','<div class="thumb-wrap" id="item_{id}">','<tpl for="file">','<div class="thumb"><img src="{thumb_url}"></div>',"</tpl>","</div>","</tpl>",'<div class="x-clear"></div>'),plugins:[new Ext.DataView.DragSelector()],emptyText:'<div class="plupload_emptytext"><span>Nessun elemento.</span></div>',prepareData:function(b){b.short_label=Ext.util.Format.ellipsis(b.label,15);return b}});Aybu.Base.DataView.superclass.constructor.call(this,a)},initComponent:function(){Aybu.Base.DataView.superclass.initComponent.apply(this,arguments);this.addEvents("datachange","deleteselected");this.getStore().addListener("save",this.onSave,this);this.getStore().addListener("exception",this.onException,this)},onSave:function(a,b,c){this.fireEvent("datachange")},onException:function(e,f,g,c,b,a){if(g=="create"&&!a){this.getStore().load()}else{if(g=="create"&&a){this.getStore().remove(a)}else{if(g=="update"){this.getStore().load()}}}this.fireEvent("datachanged")},deleteSelected:function(a){Ext.Msg.confirm("Conferma rimozione","Sei sicuro di voler rimuovere gli elementi selezionati?",function(f){if(f=="yes"){var c=a.getSelectedRecords();var b=a.getStore();for(var e=0;e<c.length;e++){b.remove(c[e]);b.save()}a.fireEvent("deleteselected")}})}});Ext.reg("AybuBaseDataView",Aybu.Base.DataView);Aybu.Base.Toolbar=Ext.extend(Ext.Toolbar,{constructor:function(b){b=b||{};Ext.applyIf(b,{itemId:"toolbar",items:[]});var a=[];b.buttonsCfg=b.buttonsCfg||{};if(b.buttonsCfg.select){var c={text:"Usa",itemId:"selectButton",disabled:"true",iconCls:"silk-attach",listeners:{click:function(f,e){this.fireEvent("selectclick")},scope:this}};c=b.buttonsCfg.select.cfg||c;a.push(c)}if(b.buttonsCfg.add){var c={text:"Aggiungi",itemId:"addButton",iconCls:"silk-add",listeners:{click:function(f,e){this.fireEvent("addclick")},scope:this}};c=b.buttonsCfg.add.cfg||c;a.push(c)}if(b.buttonsCfg.edit){var c={text:"Modifica",itemId:"editButton",iconCls:"silk-edit",disabled:true,listeners:{click:function(){this.fireEvent("editclick")},scope:this}};c=b.buttonsCfg.edit.cfg||c;a.push(c)}if(b.buttonsCfg.delete_){var c={text:"Rimuovi",itemId:"deleteButton",iconCls:"silk-cross",disabled:true,listeners:{click:function(){this.fireEvent("deleteclick")},scope:this}};c=b.buttonsCfg.delete_.cfg||c;a.push(c)}b.items.unshift(a);Aybu.Base.Toolbar.superclass.constructor.call(this,b)},initComponent:function(){Aybu.Base.Toolbar.superclass.initComponent.apply(this,arguments);this.addEvents("selectclick","addclick","editclick","deleteclick")},changeDisabledButtons:function(a){selectButton=this.getComponent("selectButton");editButton=this.getComponent("editButton");deleteButton=this.getComponent("deleteButton");if(a.length){selectable=false;if(a.length==1){editable=false}else{editable=true}deletable=false}else{deletable=true;editable=true;selectable=true}if(selectButton){selectButton.setDisabled(selectable)}if(editButton){editButton.setDisabled(editable)}if(deleteButton){deleteButton.setDisabled(deletable)}}});Ext.reg("AybuBaseToolbar",Aybu.Base.Toolbar);Aybu.Base.Panel=Ext.extend(Ext.Panel,{constructor:function(a){a=a||{};a.tbar=a.tbar||{};Ext.applyIf(a.tbar,{xtype:"AybuBaseToolbar",buttonsCfg:{select:true,add:true,edit:true,delete_:true}});Ext.applyIf(a,{itemId:"panel",autoScroll:true,items:{xtype:"AybuBaseDataView"},addWindow:new Ext.Window({closeAction:"hide"}),editWindow:new Ext.Window({closeAction:"hide"})});this.addWindow=a.addWindow;this.editWindow=a.editWindow;this.enableDD=a.enableDD||false;Aybu.Base.Panel.superclass.constructor.call(this,a)},initComponent:function(){Aybu.Base.Panel.superclass.initComponent.apply(this,arguments);this.addEvents("datachange");this.addEvents("selectiondone");this.getTopToolbar().addListener("selectclick",this.onSelectClick,this);this.getTopToolbar().addListener("addclick",this.onAddClick,this);this.getTopToolbar().addListener("editclick",this.onEditClick,this);this.getTopToolbar().addListener("deleteclick",this.onDeleteClick,this);this.getComponent(0).addListener("selectionchange",this.onSelectionChange,this);this.getComponent(0).addListener("dblclick",this.onDoubleClick,this);this.getComponent(0).addListener("datachange",this.onDataChange,this);this.getComponent(0).addListener("deleteselected",this.onDeleteSelected,this);if(this.enableDD){this.getComponent(0).addListener("render",this.initializeDragZone,this);this.getComponent(0).addListener("render",this.initializeDropZone,this)}if(this.addWindow){this.addWindow.addListener("selectiondone",this.onSelectionDone,this)}if(this.editWindow){this.editWindow.addListener("editdone",this.onEditDone,this)}},onSelectClick:function(c,b){var a=this.getComponent(0);this.fireEvent("selectiondone",a.getSelectedRecords());a.clearSelections()},onAddClick:function(b,a){this.addWindow.show()},onEditClick:function(c,b){var a=this.getComponent(0).getSelectedRecords();if(a.length>1){Ext.Msg.alert("Errore","La modifica multipla non è supportata.")}else{this.editWindow.setRecord(a[0]);this.editWindow.show()}},onDeleteClick:function(){var a=this.getComponent(0);a.deleteSelected(a)},onSelectionDone:function(a){Ext.Msg.alert("Seleziona Elementi","La funzionalità non è implementata.")},onSelectionChange:function(a,b){this.getTopToolbar().changeDisabledButtons(b)},onDoubleClick:function(a,b,e,c){this.editWindow.setRecord(a.getRecord(e));this.editWindow.show()},onDataChange:function(){this.fireEvent("datachange")},onEditDone:function(){this.editWindow.hide();this.getComponent(0).store.save()},onDeleteSelected:function(){Ext.Msg.alert("Elimina Elementi","La funzionalità non è implementata.")},initializeDragZone:function(a){a.dragZone=new Ext.dd.DragZone(a.getEl(),{onDrag:function(b){a.clearSelections()},getDragData:function(f){var c=f.getTarget(a.itemSelector,10);if(c){d=c.cloneNode(true);var b=a.getRecord(c);d.id=Ext.id();return a.dragData={sourceEl:c,repairXY:Ext.fly(c).getXY(),ddel:d,record:b,store:a.getStore()}}},getRepairXY:function(){return this.dragData.repairXY}})},initializeDropZone:function(a){a.dropZone=new Ext.dd.DropZone(a.getEl(),{getTargetFromEvent:function(b){return b.getTarget("div.thumb-wrap")},onNodeEnter:function(g,b,f,c){Ext.fly(g).addClass("dd-target-hover")},onNodeOut:function(g,b,f,c){Ext.fly(g).removeClass("dd-target-hover")},onNodeOver:function(g,b,f,c){return Ext.dd.DropZone.prototype.dropAllowed},onNodeDrop:function(l,q,m,h){var k=a.getRecord(l);var p=a.getStore();var c=p.indexOf(h.record);var o=p.indexOf(k);var j=k.data.weight;var f=p.getCount();if(o==0){j-=1}else{if(o==f-1){j+=1}else{if(c<o){for(var g=f-1;g>-1;g--){if(g>o){var b=p.getAt(g);b.set("weight",b.data.weight+1)}}j+=1}else{if(c>o){for(var g=0;g<f;g++){if(g<o){var b=p.getAt(g);b.set("weight",b.data.weight-1)}}j-=1}}}}h.record.set("weight",j);p.sort("weight","ASC");p.save();return true}})}});Ext.reg("AybuBasePanel",Aybu.Base.Panel);Aybu.Base.Window=Ext.extend(Ext.Window,{constructor:function(a){a=a||{};Ext.applyIf(a,{title:"Window Title",width:270,height:Ext.getBody().getViewSize().height,layout:"fit",closable:true,collapsible:true,expandOnShow:false,closeAction:"hide",x:0,y:0,items:{xtype:"AybuBasePanel"}});Aybu.Base.Window.superclass.constructor.call(this,a)},initComponent:function(){Aybu.Base.Window.superclass.initComponent.apply(this,arguments);this.addEvents("selectiondone");this.getComponent(0).addListener("datachange",this.onDataChange,this);this.getComponent(0).addListener("selectiondone",this.onSelectionDone,this)},onDataChange:function(a,b,c){},onSelectionDone:function(a){this.fireEvent("selectiondone",a);this.hide()}});Ext.reg("AybuBaseWindow",Aybu.Base.Window);Aybu.Base.EditPanel=Ext.extend(Ext.form.FormPanel,{constructor:function(a){a=a||{};Ext.applyIf(a,{bodyStyle:"padding: 15px",items:[],buttons:[{text:"Salva",handler:this.submit,scope:this},{text:"Esci",handler:this.onExit,scope:this}]});Aybu.Base.EditPanel.superclass.constructor.call(this,a)},initComponent:function(){Aybu.Base.EditPanel.superclass.initComponent.apply(this,arguments);this.addEvents("editend")},getValues:function(){return null},submit:function(a,b){this.fireEvent("editend",this.getValues())},onExit:function(a,b){this.fireEvent("editend",null)}});Ext.reg("AybuBaseEditPanel",Aybu.Base.EditPanel);Aybu.Base.EditWindow=Ext.extend(Ext.Window,{constructor:function(a){a=a||{};this.setRecord=a.setRecord||undefined;Ext.applyIf(a,{title:"Edit Window Title",width:320,height:Ext.getBody().getViewSize().height,layout:"fit",closable:false,collapsible:false,expandOnShow:false,closeAction:"hide",items:{xtype:"AybuBaseEditPanel"},modal:true});Aybu.Base.EditWindow.superclass.constructor.call(this,a)},initComponent:function(){Aybu.Base.EditWindow.superclass.initComponent.apply(this,arguments);this.getComponent(0).addListener("editend",this.onEditEnd,this);this.addEvents("editdone")},onEditEnd:function(a){this.fireEvent("editdone",a)}});Ext.reg("AybuBaseEditWindow",Aybu.Base.EditWindow);