Ext.ns("TreeManager");TreeManager.TreeGrid=Ext.extend(Ext.ux.tree.TreeGrid,{selectedNode:null,initComponent:function(){var b=new Ext.list.BooleanColumn({header:"Abilitato",dataIndex:"enabled",align:"center",tpl:'<div class="enabled_{enabled}">&nbsp;</div>',width:45});var a={rootVisible:false,title:"Gestione Pagine",width:560,enableDD:true,enableSort:false,dataUrl:urls.tree,columns:[{header:"Etichetta",dataIndex:"button_label",width:170},{header:"ID",dataIndex:"id",width:25,hidden:true},{header:"Titolo",dataIndex:"title",width:170},{header:"URL",dataIndex:"url",width:170},b],tbar:[{text:"Nuova",tooltip:"Aggiungi",iconCls:"silk-add",handler:this.show_form,ref:"../addButton",scope:this},"-",{text:"Modifica",tooltip:"Modifica",iconCls:"silk-edit",handler:this.show_form,ref:"../editButton",disabled:true,scope:this},"-",{text:"Elimina",tooltip:"Rimuovi",iconCls:"silk-cross",handler:this.delete_button_clicked,ref:"../deleteButton",disabled:true,scope:this}]};Ext.apply(this,Ext.apply(this.initialConfig,a));TreeManager.TreeGrid.superclass.initComponent.call(this);this.addListener("dblclick",this.dblclick);this.addListener("click",this.click);this.addListener("nodedragover",this.nodedragover);this.addListener("dragdrop",this.dragdrop);this.getRootNode().allowChildren=false},click:function(a,b){this.selectedNode=a;if(a.attributes.type!="Menu"){this.editButton.enable();this.deleteButton.enable();if(a.attributes.type=="InternalLink"||a.attributes.type=="ExternalLink"){this.addButton.disable()}else{this.addButton.enable()}}else{this.editButton.disable();this.deleteButton.disable();this.addButton.enable()}},dblclick:function(a,b){this.selectedNode=a;type=this.selectedNode.attributes.type;if(type!="Menu"){id=this.selectedNode.attributes.id;this.win=new TreeManager.FormWin({title:"Modifica"});this.win.show(id,null,type)}},dragdrop:function(b,c,a,d){waitMessage=Ext.Msg.wait("Aggiornamento","Aggiornamento struttura in corso... ");options={url:urls.move,params:{moved_node_id:c.id,new_parent_id:c.parentNode.id,previous_node_id:c.previousSibling!=null?c.previousSibling.id:null,next_node_id:c.nextSibling!=null?c.nextSibling.id:null},success:function(e){window.location.reload(true)},failure:function(e){alert(e.responseText);waitMessage.hide();this.getRootNode().reload()},scope:this,waitMsg:"Elimino..."};Ext.Ajax.request(options)},nodedragover:function(a){type=a.target.attributes.type;if(type=="Page"||type=="Section"||type=="Menu"||type=="MediaCollectionPage"){console.log(this.dropZone);return true}a.cancel=true;return false},show_form:function(a,b){if(a==this.addButton){this.win=new TreeManager.FormWin({title:"Nuova"});parent_id=null;if(this.selectedNode!=null){parent_type=this.selectedNode.attributes.type;if(parent_type=="MediaCollectionPage"||parent_type=="Page"||parent_type=="Section"||parent_type=="Menu"){parent_id=this.selectedNode.attributes.id}}this.win.show(null,parent_id,"Page")}else{if(a==this.editButton){id=this.selectedNode.attributes.id;type=this.selectedNode.attributes.type;this.win=new TreeManager.FormWin({title:"Modifica"});this.win.show(id,null,type)}}},delete_button_clicked:function(a,b){Ext.Msg.confirm("Eliminare la pagina/sezione?","Sei sicuro di voler eliminare la pagina/sezione selezionata? (non potr√† essere recuperata)",this.delete_selected_pages,this)},delete_selected_pages:function(a){if(a!="yes"){return}waitMessage=Ext.Msg.wait("Rimozione","Rimozione in corso... ");options={url:urls.destroy,params:{id:this.selectedNode.attributes.id},success:function(b){window.location.reload(true)},failure:function(b){waitMessage.hide();var c=Ext.util.JSON.decode(b.responseText);Ext.Msg.alert("Errore durante la rimozione",c.error)},scope:this,waitMsg:"Elimino..."};Ext.Ajax.request(options)}});